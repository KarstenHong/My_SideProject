<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ´ªå¸«å‚…2026é‡‘é¦¬å¹´èœ - å¿«é€Ÿé»é¤</title>
    <link rel="stylesheet" href="ChineseNewYear_Dishes.css" />

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
      /* ä¸€é å¼é»é¤å°ˆç”¨æ¨£å¼ */
      body {
        padding: 0;
        overflow: hidden;
      }

      .container {
        max-width: 100vw;
        height: 100vh;
        border-radius: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      header {
        padding: 15px 20px;
        flex-shrink: 0;
      }

      header h1 {
        font-size: 1.8em;
        margin-bottom: 5px;
      }

      header p {
        font-size: 0.95em;
      }

      .nav-bar {
        background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      .nav-bar a {
        color: white;
        text-decoration: none;
        padding: 8px 20px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        transition: all 0.3s ease;
        font-weight: bold;
      }

      .nav-bar a:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }

      .order-content {
        display: flex;
        flex: 1;
        overflow: hidden;
        padding: 15px;
        gap: 15px;
      }

      .dishes-panel {
        flex: 1.5;
        background: #f8f9fa;
        border-radius: 12px;
        padding: 15px;
        overflow-y: auto;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .customer-panel {
        flex: 1;
        background: #fff;
        border-radius: 12px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .panel-title {
        font-size: 1.3em;
        color: #e74c3c;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e74c3c;
      }

      /* èœå“ç¶²æ ¼ä½ˆå±€ */
      .dishes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 12px;
        margin-bottom: 15px;
      }

      .dish-card {
        background: white;
        border-radius: 10px;
        padding: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .dish-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      }

      .dish-name {
        font-weight: bold;
        color: #333;
        font-size: 0.95em;
        text-align: center;
      }

      .dish-price {
        color: #e74c3c;
        font-weight: bold;
        text-align: center;
        font-size: 0.9em;
      }

      .dish-quantity-control {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .qty-btn {
        width: 30px;
        height: 30px;
        border: none;
        border-radius: 6px;
        background: #e74c3c;
        color: white;
        font-size: 1.2em;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .qty-btn:hover {
        background: #c0392b;
        transform: scale(1.1);
      }

      .qty-display {
        min-width: 35px;
        text-align: center;
        font-weight: bold;
        font-size: 1.1em;
        color: #333;
      }

      /* å®¢æˆ¶è³‡è¨Šè¡¨å–® */
      .customer-form {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
        overflow-y: auto;
      }

      .form-field-compact {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .form-field-compact label {
        font-size: 0.9em;
        color: #555;
        font-weight: bold;
      }

      .form-field-compact input,
      .form-field-compact select,
      .form-field-compact textarea {
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 0.95em;
        transition: border-color 0.3s;
      }

      .form-field-compact input:focus,
      .form-field-compact select:focus,
      .form-field-compact textarea:focus {
        outline: none;
        border-color: #e74c3c;
      }

      .group-input-container-compact {
        display: flex;
        gap: 8px;
      }

      .group-input-container-compact select {
        flex: 1;
      }

      .btn-add-group-compact {
        padding: 8px 15px;
        background: #27ae60;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        white-space: nowrap;
      }

      .btn-add-group-compact:hover {
        background: #229954;
      }

      /* è¨‚å–®ç¸½è¨ˆå€ */
      .order-summary {
        background: linear-gradient(135deg, #fff5e6 0%, #ffe6e6 100%);
        padding: 15px;
        border-radius: 10px;
        margin-top: auto;
        flex-shrink: 0;
      }

      .total-display {
        font-size: 1.8em;
        color: #e74c3c;
        font-weight: bold;
        text-align: center;
        margin: 10px 0;
      }

      /* æ“ä½œæŒ‰éˆ• */
      .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .btn-submit-order {
        flex: 2;
        padding: 12px;
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.1em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-submit-order:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
      }

      .btn-reset-order {
        flex: 1;
        padding: 12px;
        background: #95a5a6;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-reset-order:hover {
        background: #7f8c8d;
      }

      /* æ»¾å‹•æ¢æ¨£å¼ */
      .dishes-panel::-webkit-scrollbar,
      .customer-form::-webkit-scrollbar {
        width: 8px;
      }

      .dishes-panel::-webkit-scrollbar-track,
      .customer-form::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      .dishes-panel::-webkit-scrollbar-thumb,
      .customer-form::-webkit-scrollbar-thumb {
        background: #e74c3c;
        border-radius: 10px;
      }

      .dishes-panel::-webkit-scrollbar-thumb:hover,
      .customer-form::-webkit-scrollbar-thumb:hover {
        background: #c0392b;
      }

      /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
      @media (max-width: 1024px) {
        .order-content {
          flex-direction: column;
        }

        .dishes-panel,
        .customer-panel {
          flex: 1;
        }
      }

      /* æ‰‹æ©Ÿç‰ˆï¼šæ”¹ç‚ºå¯æ»¾å‹•çš„é•·é é¢ */
      @media (max-width: 768px) {
        body {
          overflow: auto !important;
        }

        .container {
          height: auto !important;
          min-height: 100vh;
          overflow: visible !important;
        }

        .order-content {
          flex-direction: column;
          overflow: visible !important;
          padding: 10px;
          gap: 10px;
        }

        .dishes-panel {
          flex: none !important;
          height: auto !important;
          overflow: visible !important;
          max-height: none !important;
          padding: 12px;
        }

        .customer-panel {
          flex: none !important;
          height: auto !important;
          overflow: visible !important;
        }

        .dishes-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
        }

        .dish-card {
          padding: 10px;
        }

        .dish-name {
          font-size: 0.85em;
        }

        .dish-price {
          font-size: 0.85em;
        }

        .qty-btn {
          width: 36px;
          height: 36px;
          font-size: 1.3em;
        }

        .qty-display {
          min-width: 30px;
          font-size: 1.1em;
        }

        header {
          padding: 12px 15px;
        }

        header h1 {
          font-size: 1.3em;
        }

        header p {
          font-size: 0.85em;
        }

        .nav-bar {
          padding: 8px 15px;
        }

        .nav-bar a {
          padding: 6px 12px;
          font-size: 0.9em;
        }

        .panel-title {
          font-size: 1.1em;
          margin-bottom: 12px;
          padding-bottom: 8px;
        }

        .customer-form {
          overflow: visible !important;
        }

        .order-summary {
          padding: 12px;
          position: sticky;
          bottom: 0;
          z-index: 100;
          margin: 10px -12px -15px -12px;
          border-radius: 0;
        }

        .total-display {
          font-size: 1.5em;
        }

        .action-buttons {
          gap: 8px;
        }

        .btn-submit-order,
        .btn-reset-order {
          padding: 10px;
          font-size: 0.95em;
        }
      }

      /* æ›´å°çš„è¢å¹• */
      @media (max-width: 400px) {
        .dishes-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 8px;
        }

        .dish-card {
          padding: 8px;
        }

        .dish-name {
          font-size: 0.8em;
        }

        .qty-btn {
          width: 32px;
          height: 32px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ğŸ§§ æ´ªå¸«å‚…2026é‡‘é¦¬å¹´èœ ğŸ§§</h1>
        <p>æ­¡è¿è¨‚è³¼ç¾å‘³å¹´èœï¼Œè®“æ‚¨çš„æ–°å¹´å¥½é‹ä¾†ï¼</p>
      </header>

      <div class="nav-bar">
        <div style="color: white; font-weight: bold">ğŸ“ å¿«é€Ÿé»é¤</div>
        <a href="management.html">ğŸ“Š è¨‚å–®ç®¡ç†</a>
      </div>

      <div class="order-content">
        <!-- å·¦å´ï¼šèœå“é¸æ“‡ -->
        <div class="dishes-panel">
          <h2 class="panel-title">ğŸ½ï¸ é¸æ“‡èœå“</h2>
          <div class="dishes-grid" id="dishesGrid">
            <!-- ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
          </div>
        </div>

        <!-- å³å´ï¼šå®¢æˆ¶è³‡è¨Šèˆ‡è¨‚å–® -->
        <div class="customer-panel">
          <h2 class="panel-title">ğŸ‘¤ è¨‚è³¼è³‡è¨Š</h2>
          <form
            id="orderForm"
            class="customer-form"
            onsubmit="
              submitOrder(event);
              return false;
            "
          >
            <div class="form-field-compact">
              <label for="orderNumber">è¨‚å–®è™Ÿç¢¼ *</label>
              <input
                type="text"
                id="orderNumber"
                placeholder="è«‹è¼¸å…¥è¨‚å–®è™Ÿç¢¼"
                required
              />
            </div>

            <div class="form-field-compact">
              <label for="customerName">å§“å *</label>
              <input
                type="text"
                id="customerName"
                placeholder="è«‹è¼¸å…¥å§“å"
                required
              />
            </div>

            <div class="form-field-compact">
              <label for="customerPhone">è¯çµ¡é›»è©± *</label>
              <input
                type="tel"
                id="customerPhone"
                placeholder="è«‹è¼¸å…¥é›»è©±"
                required
              />
            </div>

            <div class="form-field-compact">
              <label for="customerGroup">æ‰€å±¬ç¾¤çµ„ *</label>
              <div class="group-input-container-compact">
                <select id="customerGroup" required>
                  <option value="">è«‹é¸æ“‡ç¾¤çµ„</option>
                  <option value="é›»è©±è¨‚è³¼">é›»è©±è¨‚è³¼</option>
                  <option value="å°ç£ç‰¹æµ¦">å°ç£ç‰¹æµ¦</option>
                  <option value="ä¸‰éš†é„‰è¦ª">ä¸‰éš†é„‰è¦ª</option>
                  <option value="èŒ‚å”ä»£è¨‚">èŒ‚å”ä»£è¨‚</option>
                  <option value="å¯å¯ä»£è¨‚">å¯å¯ä»£è¨‚</option>
                </select>
                <button
                  type="button"
                  class="btn-add-group-compact"
                  onclick="addNewGroup()"
                >
                  æ–°å¢
                </button>
              </div>
            </div>

            <div class="form-field-compact">
              <label for="customerNote">å‚™è¨»</label>
              <textarea
                id="customerNote"
                rows="2"
                placeholder="ç‰¹æ®Šéœ€æ±‚æˆ–å‚™è¨»äº‹é …"
              ></textarea>
            </div>

            <div class="order-summary">
              <div style="text-align: center; color: #555; font-size: 0.95em">
                è¨‚å–®ç¸½é‡‘é¡
              </div>
              <div class="total-display">
                NT$ <span id="orderTotal">0</span>
              </div>
              <div class="action-buttons">
                <button
                  type="button"
                  class="btn-reset-order"
                  onclick="resetOrderForm()"
                >
                  ğŸ”„ é‡ç½®
                </button>
                <button type="submit" class="btn-submit-order">
                  âœ… é€å‡ºè¨‚å–®
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- è‡ªè¨‚æç¤ºçª— -->
    <div id="customAlert" class="custom-alert-overlay">
      <div class="custom-alert-box">
        <div class="custom-alert-icon" id="alertIcon"></div>
        <div class="custom-alert-message" id="alertMessage"></div>
        <div class="custom-alert-buttons" id="alertButtons"></div>
      </div>
    </div>

    <!-- Firebase é…ç½® -->
    <script src="firebase-config.js"></script>

    <script src="ChineseNewYear_Dishes.js"></script>
    <script>
      // é»é¤é é¢å°ˆç”¨è…³æœ¬
      let dishQuantities = {};

      // åˆå§‹åŒ–é é¢
      document.addEventListener("DOMContentLoaded", async function () {
        await initializeOrderPage();
      });

      async function initializeOrderPage() {
        try {
          // ç­‰å¾…ä¸»è…³æœ¬è¼‰å…¥å®Œæˆ
          if (typeof DISHES === "undefined") {
            console.error("DISHES æœªå®šç¾©ï¼Œç­‰å¾…è¼‰å…¥...");
            setTimeout(initializeOrderPage, 100);
            return;
          }

          // ç¢ºä¿ dishes å…¨å±€è®Šæ•¸å¯ç”¨
          if (typeof dishes === "undefined") {
            window.dishes = DISHES;
          }

          renderDishesGrid();
          updateGroupOptions();
        } catch (error) {
          console.error("åˆå§‹åŒ–å¤±æ•—:", error);
          showAlert("ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢", "error");
        }
      }

      function renderDishesGrid() {
        const grid = document.getElementById("dishesGrid");
        if (!grid) {
          console.error("æ‰¾ä¸åˆ° dishesGrid å…ƒç´ ");
          return;
        }

        grid.innerHTML = "";

        // ä½¿ç”¨å…¨å±€çš„ DISHES æˆ– dishes
        const dishesArray = window.DISHES || window.dishes || [];

        if (dishesArray.length === 0) {
          console.warn("æ²’æœ‰èœå“è³‡æ–™");
          grid.innerHTML =
            '<div style="grid-column: 1/-1; text-align:center; padding:20px; color:#999;">æš«ç„¡èœå“ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
          return;
        }

        dishesArray.forEach((dish, index) => {
          const card = document.createElement("div");
          card.className = "dish-card";
          card.innerHTML = `
            <div class="dish-name">${dish.name}</div>
            <div class="dish-price">NT$ ${dish.price}</div>
            <div class="dish-quantity-control">
              <button type="button" class="qty-btn" onclick="decrementDish(${index})">âˆ’</button>
              <div class="qty-display" id="qty-${index}">0</div>
              <button type="button" class="qty-btn" onclick="incrementDish(${index})">+</button>
            </div>
          `;
          grid.appendChild(card);
          dishQuantities[index] = 0;
        });
      }

      function incrementDish(index) {
        dishQuantities[index]++;
        updateDishDisplay(index);
        calculateOrderTotal();
      }

      function decrementDish(index) {
        if (dishQuantities[index] > 0) {
          dishQuantities[index]--;
          updateDishDisplay(index);
          calculateOrderTotal();
        }
      }

      function updateDishDisplay(index) {
        const qtyElement = document.getElementById(`qty-${index}`);
        if (qtyElement) {
          qtyElement.textContent = dishQuantities[index];
          // è¦–è¦ºå›é¥‹
          qtyElement.style.transform = "scale(1.3)";
          qtyElement.style.color = "#e74c3c";
          setTimeout(() => {
            qtyElement.style.transform = "scale(1)";
            qtyElement.style.color = "#333";
          }, 200);
        }
      }

      function calculateOrderTotal() {
        let total = 0;
        const dishesArray = window.DISHES || window.dishes || [];

        Object.keys(dishQuantities).forEach((index) => {
          const quantity = dishQuantities[index];
          if (quantity > 0 && dishesArray[index]) {
            total += dishesArray[index].price * quantity;
          }
        });

        const totalElement = document.getElementById("orderTotal");
        if (totalElement) {
          totalElement.textContent = total.toLocaleString();
        }
      }

      function resetOrderForm() {
        showConfirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å…§å®¹å—ï¼Ÿ", () => {
          clearOrderForm();
        });
      }

      // ç›´æ¥æ¸…ç©ºè¡¨å–®ï¼ˆä¸éœ€ç¢ºèªï¼‰
      function clearOrderForm() {
        // é‡ç½®æ•¸é‡
        Object.keys(dishQuantities).forEach((index) => {
          dishQuantities[index] = 0;
          updateDishDisplay(index);
        });

        // é‡ç½®è¡¨å–®
        document.getElementById("orderForm").reset();
        calculateOrderTotal();
      }

      async function submitOrder(event) {
        event.preventDefault();

        // æ”¶é›†è¨‚å–®è³‡æ–™
        const orderNumber = document.getElementById("orderNumber").value.trim();
        const customerName = document
          .getElementById("customerName")
          .value.trim();
        const customerPhone = document
          .getElementById("customerPhone")
          .value.trim();
        const customerGroup = document.getElementById("customerGroup").value;
        const customerNote = document
          .getElementById("customerNote")
          .value.trim();

        // é©—è­‰å¿…å¡«æ¬„ä½
        if (!orderNumber || !customerName || !customerPhone || !customerGroup) {
          showAlert("è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼", "error");
          return;
        }

        // æ”¶é›†è¨‚è³¼èœå“ - å»ºç«‹ dishQuantities ç‰©ä»¶
        const dishesArray = window.DISHES || window.dishes || [];
        const orderDishQuantities = {};
        let hasOrder = false;

        Object.keys(dishQuantities).forEach((index) => {
          const quantity = dishQuantities[index];
          if (quantity > 0 && dishesArray[index]) {
            orderDishQuantities[dishesArray[index].name] = quantity;
            hasOrder = true;
          }
        });

        if (!hasOrder) {
          showAlert("è«‹è‡³å°‘é¸æ“‡ä¸€é …èœå“ï¼", "error");
          return;
        }

        // è¨ˆç®—ç¸½é‡‘é¡
        let total = 0;
        dishesArray.forEach((dish) => {
          const qty = orderDishQuantities[dish.name] || 0;
          total += dish.price * qty;
        });

        // å»ºç«‹è¨‚å–®ç‰©ä»¶ï¼ˆç¬¦åˆä¸» JS çš„æ ¼å¼ï¼‰
        const orderData = {
          id: Date.now(),
          orderNumber: orderNumber,
          customer: {
            name: customerName,
            phone: customerPhone,
            group: customerGroup,
            note: customerNote,
          },
          dishQuantities: orderDishQuantities,
          total: total,
          createdAt: new Date().toISOString(),
        };

        try {
          // æª¢æŸ¥è¨‚å–®è™Ÿç¢¼æ˜¯å¦é‡è¤‡
          if (typeof checkOrderNumberExists === "function") {
            const exists = await checkOrderNumberExists(orderNumber);
            if (exists) {
              showAlert("æ­¤è¨‚å–®è™Ÿç¢¼å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–è™Ÿç¢¼ï¼", "error");
              return;
            }
          }

          // å„²å­˜åˆ° Firebase
          if (typeof addOrderToFirebase === "function") {
            await addOrderToFirebase(orderData);

            // ç›´æ¥é‡ç½®è¡¨å–®ï¼ˆä¸éœ€ç¢ºèªï¼‰
            clearOrderForm();

            showAlert(
              `è¨‚å–®é€å‡ºæˆåŠŸï¼\nè¨‚å–®è™Ÿç¢¼ï¼š${orderNumber}\nç¸½é‡‘é¡ï¼šNT$ ${total.toLocaleString()}`,
              "success",
            );
          } else {
            // å‚™ç”¨ï¼šå„²å­˜åˆ° localStorage
            const orders = JSON.parse(localStorage.getItem("orders")) || [];
            orders.push(orderData);
            localStorage.setItem("orders", JSON.stringify(orders));

            // ç›´æ¥é‡ç½®è¡¨å–®ï¼ˆä¸éœ€ç¢ºèªï¼‰
            clearOrderForm();

            showAlert(
              `è¨‚å–®é€å‡ºæˆåŠŸï¼\nè¨‚å–®è™Ÿç¢¼ï¼š${orderNumber}\nç¸½é‡‘é¡ï¼šNT$ ${total.toLocaleString()}`,
              "success",
            );
          }
        } catch (error) {
          console.error("è¨‚å–®é€å‡ºå¤±æ•—:", error);
          showAlert(
            "è¨‚å–®é€å‡ºå¤±æ•—ï¼š" + (error.message || "è«‹ç¨å¾Œå†è©¦"),
            "error",
          );
        }
      }
    </script>
  </body>
</html>
